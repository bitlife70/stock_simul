#!/usr/bin/env python3
"""
Daily CRON Job Setup for Korean Stock Data Updates
Windows ì‘ì—… ìŠ¤ì¼€ì¤„ëŸ¬ ë˜ëŠ” Linux crontab ì„¤ì •ì„ ìœ„í•œ ìŠ¤í¬ë¦½íŠ¸
"""

import os
import sys
import platform
from pathlib import Path

def setup_windows_task():
    """Windows ì‘ì—… ìŠ¤ì¼€ì¤„ëŸ¬ ì„¤ì •"""
    script_dir = Path(__file__).parent.absolute()
    python_exe = sys.executable
    update_script = script_dir / "run_batch_update.py"
    
    # Windows ì‘ì—… ìŠ¤ì¼€ì¤„ëŸ¬ ëª…ë ¹
    task_name = "KoreanStockDataUpdate"
    
    # XML í˜•ì‹ì˜ ì‘ì—… ì •ì˜
    task_xml = f"""<?xml version="1.0" encoding="UTF-16"?>
<Task version="1.4" xmlns="http://schemas.microsoft.com/windows/2004/02/mit/task">
  <RegistrationInfo>
    <Date>2024-01-01T09:00:00</Date>
    <Author>Korean Stock Simulation</Author>
    <Description>Daily update of Korean stock market data</Description>
  </RegistrationInfo>
  <Triggers>
    <CalendarTrigger>
      <StartBoundary>2024-01-01T06:00:00</StartBoundary>
      <Enabled>true</Enabled>
      <ScheduleByDay>
        <DaysInterval>1</DaysInterval>
      </ScheduleByDay>
    </CalendarTrigger>
  </Triggers>
  <Principals>
    <Principal id="Author">
      <LogonType>InteractiveToken</LogonType>
      <RunLevel>LeastPrivilege</RunLevel>
    </Principal>
  </Principals>
  <Settings>
    <MultipleInstancesPolicy>IgnoreNew</MultipleInstancesPolicy>
    <DisallowStartIfOnBatteries>false</DisallowStartIfOnBatteries>
    <StopIfGoingOnBatteries>false</StopIfGoingOnBatteries>
    <AllowHardTerminate>true</AllowHardTerminate>
    <StartWhenAvailable>true</StartWhenAvailable>
    <RunOnlyIfNetworkAvailable>true</RunOnlyIfNetworkAvailable>
    <IdleSettings>
      <StopOnIdleEnd>false</StopOnIdleEnd>
      <RestartOnIdle>false</RestartOnIdle>
    </IdleSettings>
    <AllowStartOnDemand>true</AllowStartOnDemand>
    <Enabled>true</Enabled>
    <Hidden>false</Hidden>
    <RunOnlyIfIdle>false</RunOnlyIfIdle>
    <DisallowStartOnRemoteAppSession>false</DisallowStartOnRemoteAppSession>
    <UseUnifiedSchedulingEngine>true</UseUnifiedSchedulingEngine>
    <WakeToRun>false</WakeToRun>
    <ExecutionTimeLimit>PT2H</ExecutionTimeLimit>
    <Priority>7</Priority>
  </Settings>
  <Actions Context="Author">
    <Exec>
      <Command>{python_exe}</Command>
      <Arguments>"{update_script}"</Arguments>
      <WorkingDirectory>{script_dir}</WorkingDirectory>
    </Exec>
  </Actions>
</Task>"""
    
    # XML íŒŒì¼ ì €ì¥
    xml_file = script_dir / f"{task_name}.xml"
    with open(xml_file, 'w', encoding='utf-16') as f:
        f.write(task_xml)
    
    print("ğŸªŸ Windows ì‘ì—… ìŠ¤ì¼€ì¤„ëŸ¬ ì„¤ì •")
    print("=" * 40)
    print(f"1. ìƒì„±ëœ XML íŒŒì¼: {xml_file}")
    print()
    print("ìˆ˜ë™ ì„¤ì • ë°©ë²•:")
    print("1. ì‘ì—… ìŠ¤ì¼€ì¤„ëŸ¬ ì—´ê¸° (taskschd.msc)")
    print("2. 'ì‘ì—… ê°€ì ¸ì˜¤ê¸°' í´ë¦­")
    print(f"3. {xml_file} ì„ íƒ")
    print("4. ì„¤ì • í™•ì¸ í›„ ì™„ë£Œ")
    print()
    print("ë˜ëŠ” ëª…ë ¹ì¤„ì—ì„œ:")
    print(f'schtasks /create /tn "{task_name}" /xml "{xml_file}"')
    
    return xml_file

def setup_linux_cron():
    """Linux crontab ì„¤ì •"""
    script_dir = Path(__file__).parent.absolute()
    python_exe = sys.executable
    update_script = script_dir / "run_batch_update.py"
    log_file = script_dir / "logs" / "daily_update.log"
    
    # ë¡œê·¸ ë””ë ‰í† ë¦¬ ìƒì„±
    log_file.parent.mkdir(exist_ok=True)
    
    # crontab í•­ëª©
    cron_entry = f"0 6 * * * {python_exe} {update_script} >> {log_file} 2>&1"
    
    print("ğŸ§ Linux Crontab ì„¤ì •")
    print("=" * 40)
    print("ë‹¤ìŒ ëª…ë ¹ì„ ì‹¤í–‰í•˜ì„¸ìš”:")
    print()
    print("1. crontab í¸ì§‘:")
    print("   crontab -e")
    print()
    print("2. ë‹¤ìŒ ì¤„ ì¶”ê°€:")
    print(f"   {cron_entry}")
    print()
    print("ì„¤ëª…:")
    print("  - ë§¤ì¼ ì˜¤ì „ 6ì‹œì— ì‹¤í–‰")
    print(f"  - ë¡œê·¸ëŠ” {log_file}ì— ì €ì¥")
    print("  - ë„¤íŠ¸ì›Œí¬ ì—°ê²° í•„ìš”")
    
    # ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ê¶Œí•œ ì„¤ì •
    os.chmod(update_script, 0o755)
    print(f"âœ… ì‹¤í–‰ ê¶Œí•œ ì„¤ì • ì™„ë£Œ: {update_script}")
    
    return cron_entry

def setup_service_script():
    """ì‹œìŠ¤í…œ ì„œë¹„ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±"""
    script_dir = Path(__file__).parent.absolute()
    
    if platform.system() == "Windows":
        # Windows ë°°ì¹˜ íŒŒì¼
        batch_content = f"""@echo off
cd /d "{script_dir}"
python run_batch_update.py
if %errorlevel% neq 0 (
    echo Error occurred during stock data update
    exit /b %errorlevel%
)
echo Stock data update completed successfully
"""
        batch_file = script_dir / "daily_update.bat"
        with open(batch_file, 'w', encoding='utf-8') as f:
            f.write(batch_content)
        
        print(f"ğŸ“„ Windows ë°°ì¹˜ íŒŒì¼ ìƒì„±: {batch_file}")
        return batch_file
        
    else:
        # Linux ì…¸ ìŠ¤í¬ë¦½íŠ¸
        shell_content = f"""#!/bin/bash
# Korean Stock Data Daily Update Service
# Auto-generated by setup_daily_cron.py

cd "{script_dir}"
python3 run_batch_update.py

if [ $? -ne 0 ]; then
    echo "Error occurred during stock data update"
    exit 1
fi

echo "Stock data update completed successfully"
"""
        shell_file = script_dir / "daily_update.sh"
        with open(shell_file, 'w', encoding='utf-8') as f:
            f.write(shell_content)
        
        os.chmod(shell_file, 0o755)
        print(f"ğŸ“„ Linux ì…¸ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±: {shell_file}")
        return shell_file

def main():
    print("ğŸ• Korean Stock Data - Daily Update Scheduler Setup")
    print("=" * 60)
    
    current_os = platform.system()
    print(f"ğŸ’» Detected OS: {current_os}")
    print()
    
    # ì„œë¹„ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
    service_script = setup_service_script()
    print()
    
    if current_os == "Windows":
        # Windows ì‘ì—… ìŠ¤ì¼€ì¤„ëŸ¬ ì„¤ì •
        xml_file = setup_windows_task()
        
        print()
        print("ğŸš€ ë¹ ë¥¸ í…ŒìŠ¤íŠ¸:")
        print(f"   python {Path(__file__).parent / 'run_batch_update.py'}")
        
    elif current_os == "Linux":
        # Linux crontab ì„¤ì •
        cron_entry = setup_linux_cron()
        
        print()
        print("ğŸš€ ë¹ ë¥¸ í…ŒìŠ¤íŠ¸:")
        print(f"   python3 {Path(__file__).parent / 'run_batch_update.py'}")
        
    else:
        print(f"âš ï¸  Unsupported OS: {current_os}")
        print("   ìˆ˜ë™ìœ¼ë¡œ ìŠ¤ì¼€ì¤„ë§ì„ ì„¤ì •í•´ì£¼ì„¸ìš”.")
    
    print()
    print("ğŸ“‹ ì„¤ì • ì™„ë£Œ í›„ í™•ì¸ì‚¬í•­:")
    print("1. ë„¤íŠ¸ì›Œí¬ ì—°ê²° ìƒíƒœ")
    print("2. Python ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜ (pip install -r requirements.txt)")
    print("3. ì‘ì—… ì‹¤í–‰ ê¶Œí•œ")
    print("4. ë¡œê·¸ íŒŒì¼ ì €ì¥ ê³µê°„")
    print()
    print("âœ… ìŠ¤ì¼€ì¤„ëŸ¬ ì„¤ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!")

if __name__ == "__main__":
    main()